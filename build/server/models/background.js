// Generated by CoffeeScript 1.9.3
var Background, Jimp, cozydb, fs;

cozydb = require('cozydb');

Jimp = require('jimp');

fs = require('fs');

module.exports = Background = cozydb.getModel('Background', {
  binary: cozydb.NoSchema
});

Background.createNew = function(imagePath, callback) {
  return Background.create({}, function(err, background) {
    var id;
    id = background.id;
    return new Jimp(imagePath, function(err, image) {
      var filePath;
      image.resize(1920, 1200);
      filePath = '/tmp/home-background.jpg';
      return image.write(filePath, function(err) {
        var thumbPath;
        if (err) {
          return callback(err);
        }
        image.resize(300, 200);
        thumbPath = '/tmp/home-thumb.jpg';
        return image.write(thumbPath, function(err) {
          var data;
          if (err) {
            return callback(err);
          }
          data = {
            name: 'file'
          };
          return Background.attachBinary(id, filePath, data, function(err) {
            if (err) {
              return callback(err);
            }
            data = {
              name: 'thumb'
            };
            return Background.attachBinary(id, thumbPath, data, function(err) {
              if (err) {
                return callback(err);
              }
              return fs.unlink(imagePath, function() {
                return fs.unlink(filePath, function() {
                  return fs.unlink(thumbPath, function() {
                    return callback(null, background);
                  });
                });
              });
            });
          });
        });
      });
    });
  });
};
