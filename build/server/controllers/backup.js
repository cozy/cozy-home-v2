// Generated by CoffeeScript 1.7.1
var Client, RemoteCozy;

Client = require('request-json').JsonClient;

RemoteCozy = require('../models/remotecozy');

module.exports.create = function(req, res) {
  var msg, params, target, targetPassword, targetUrl;
  targetUrl = req.body.targetUrl || null;
  targetPassword = req.body.targetPassword || null;
  if ((targetUrl != null) && (targetPassword != null)) {
    target = new Client(targetUrl);
    params = {
      login: 'cozy-backup',
      type: 'cozy'
    };
    target.setBasicAuth('owner', targetPassword);
    return target.post('device/', params, function(err, resp, body) {
      var remote, status;
      err = err || body.error;
      if (err != null) {
        status = (resp != null ? resp.statusCode : void 0) || 500;
        return res.send(status, {
          error: true,
          msg: err
        });
      } else {
        remote = {
          url: targetUrl,
          password: body.password
        };
        return RemoteCozy.create(remote, function() {
          return res.send(200, {
            success: true
          });
        });
      }
    });
  } else {
    msg = 'targetUrl and targetPassword parameters are mandatory.';
    return res.send(400, {
      error: msg
    });
  }
};

module.exports.list = function(req, res) {
  return RemoteCozy.all(function(err, remotes) {
    if (err != null) {
      return res.send(500, {
        error: err
      });
    } else {
      return res.send(200, remotes);
    }
  });
};

module.exports.fetch = function(req, res, next) {
  if (req.params.id != null) {
    return RemoteCozy.find(req.params.id, function(err, remote) {
      if ((err != null) || (remote == null)) {
        return res.send(500, err);
      } else {
        req.remote = remote;
        return next();
      }
    });
  } else {
    return res.send(400, {
      error: "id parameter is mandatory"
    });
  }
};

module.exports["delete"] = function(req, res) {
  return req.remote.destroy(function() {
    return res.send(204);
  });
};

module.exports.process = function(req, res) {
  var ds, isHttps, params, prefix, target, url;
  url = req.remote.url;
  if (url.substring(url.length - 1) !== "/") {
    url += "/";
  }
  isHttps = url.indexOf('https') === 0;
  prefix = isHttps ? 'https://' : 'http://';
  url = url.replace('https://', '');
  url = url.replace('http://', '');
  ds = new Client("http://localhost:9101/");
  ds.setBasicAuth(process.env.NAME, process.env.TOKEN);
  target = "" + prefix + "cozy-backup:" + req.remote.password + "@" + url + "cozy";
  params = {
    target: target
  };
  return ds.post('replicate', params, function(err, resp, body) {
    var status;
    err = err || (body != null ? body.error : void 0);
    if (err != null) {
      status = (resp != null ? resp.statusCode : void 0) || 500;
      return res.send(status, {
        error: err
      });
    } else {
      return res.send(204);
    }
  });
};
