// Generated by CoffeeScript 1.9.3
var Album, NotAllowed, NotFound, Photo, async, log, ref, sharing;

async = require('async');

Album = require('../models/album');

Photo = require('../models/photo');

sharing = require('./sharing');

ref = require('../helpers/errors'), NotFound = ref.NotFound, NotAllowed = ref.NotAllowed;

log = require('printit')({
  date: false,
  prefix: "album"
});

module.exports.fetch = function(req, res, next, id) {
  return Album.find(id, function(err, album) {
    if (err) {
      return next(err);
    } else if (!album) {
      return next(NotFound("Album " + id));
    } else {
      req.album = album;
      return next();
    }
  });
};

module.exports.list = function(req, res, next) {
  return Album.listWithThumbs(function(err, albums) {
    if (err) {
      return next(err);
    }
    return res.send(albums);
  });
};

module.exports.read = function(req, res, next) {
  return sharing.checkPermissions(req.album, req, function(err, isAllowed) {
    if (!isAllowed) {
      return next(NotAllowed());
    } else {
      return Photo.fromAlbum(req.album, function(err, photos) {
        var out;
        if (err) {
          return next(err);
        }
        out = req.album.toObject();
        out.photos = photos;
        return res.send(out);
      });
    }
  });
};
