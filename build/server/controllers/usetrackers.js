// Generated by CoffeeScript 1.10.0

/*
 App usage tracking
 */
var TIMING, UseTracker, appTracker, moment;

moment = require('moment-timezone');

UseTracker = require('../models/usetracker');

TIMING = 10 * 1000;

appTracker = {};

module.exports = {
  heartbeat: function(req, res, next) {
    var appInfo, appName;
    appName = req.body.appName;
    if (appTracker[appName] == null) {
      appTracker[appName] = {
        dateStart: req.body.timestamp,
        dateEnd: null,
        timeout: null
      };
    }
    appInfo = appTracker[appName];
    appInfo.dateEnd = req.body.timestamp;
    clearTimeout(appInfo.timeout);
    appInfo.timeout = setTimeout(function() {
      var data, duration;
      duration = moment(appInfo.dateEnd) - moment(appInfo.dateStart);
      duration = Math.round(duration / 1000) * 1000;
      data = {
        app: appName,
        dateStart: appInfo.dateStart,
        dateEnd: appInfo.dateEnd,
        duration: duration
      };
      delete appTracker[appName];
      return UseTracker.create(data, function(err, res, body) {
        if (err != null) {
          return console.log("Couldn't add app tracking info -- " + err);
        }
      });
    }, TIMING);
    return res.status(201).send('ok');
  }
};
